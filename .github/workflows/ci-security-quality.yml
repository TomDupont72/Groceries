name: CI - Lint + Sonar + Snyk + CodeQL + EAS Build

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint (Expo/ESLint)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: project/mobile
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: project/mobile/package-lock.json

      - run: npm ci
      - run: npm run lint

  codeql:
    name: CodeQL
    runs-on: ubuntu-latest
    needs: lint
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v3
        with:
          languages: javascript
      - uses: github/codeql-action/analyze@v3

  snyk:
    name: Snyk (Dependencies)
    runs-on: ubuntu-latest
    needs: lint
    defaults:
      run:
        working-directory: project/mobile
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: project/mobile/package-lock.json

      - run: npm ci

      - name: Snyk test
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: --severity-threshold=high --all-projects

  sonarcloud:
    name: SonarCloud Scan
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          # Sonar properties file is at repo root in your setup
          args: >
            -Dsonar.projectBaseDir=.

  eas_build_and_publish:
    name: EAS Build Android (preview) + publish URL
    runs-on: ubuntu-latest
    needs: [lint, codeql, snyk, sonarcloud]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: project/mobile/package-lock.json

      - name: Install deps
        working-directory: project/mobile
        run: npm ci

      - name: Setup Expo + EAS
        uses: expo/expo-github-action@v8
        with:
          token: ${{ secrets.EXPO_TOKEN }}
          eas-version: latest

      - name: Start EAS build (Android)
        id: start_build
        working-directory: project/mobile
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas build -p android --profile preview --non-interactive --json > eas-build.json
          cat eas-build.json

          BUILD_ID=$(node -e "const fs=require('fs'); const j=JSON.parse(fs.readFileSync('eas-build.json','utf8')); const item=Array.isArray(j)?j[0]:j; console.log(item.id || '')")
          if [ -z "$BUILD_ID" ]; then
            echo "Could not extract build id from eas-build.json"
            exit 1
          fi

          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "Build ID: $BUILD_ID"

      - name: Wait for artifacts (poll)
        id: wait
        working-directory: project/mobile
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          BUILD_ID="${{ steps.start_build.outputs.build_id }}"

          # Poll up to ~20 minutes (80 * 15s)
          for i in $(seq 1 80); do
            # ✅ Most compatible form: build id as positional argument
            if ! eas build:view "$BUILD_ID" --json --non-interactive > eas-build-view.json; then
              echo "build:view failed (attempt $i). Retrying in 15s..."
              sleep 15
              continue
            fi

            STATUS=$(node -e "const fs=require('fs'); const j=JSON.parse(fs.readFileSync('eas-build-view.json','utf8')); console.log(j.status || '')")
            URL=$(node -e "const fs=require('fs'); const j=JSON.parse(fs.readFileSync('eas-build-view.json','utf8')); console.log(j.artifacts?.buildUrl || j.artifacts?.applicationArchiveUrl || '')")

            echo "Attempt $i: status=$STATUS url=$URL"

            if [ "$STATUS" = "finished" ] && [ -n "$URL" ]; then
              echo "build_url=$URL" >> $GITHUB_OUTPUT
              exit 0
            fi

            if [ "$STATUS" = "errored" ] || [ "$STATUS" = "canceled" ]; then
              echo "Build failed with status: $STATUS"
              cat eas-build-view.json
              exit 1
            fi

            sleep 15
          done

          echo "Timed out waiting for artifacts."
          cat eas-build-view.json
          exit 1

      - name: Extract app version + versionCode
        id: version
        working-directory: project/mobile
        run: |
          VERSION=$(node -e "const p=require('./app.json'); console.log(p.expo?.version || 'unknown')")
          VERSION_CODE=$(node -e "const p=require('./app.json'); console.log(p.expo?.android?.versionCode || '0')")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          echo "VersionCode: $VERSION_CODE"

      - name: Publish build URL to Supabase (AppConfig)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          BUILD_URL: ${{ steps.wait.outputs.build_url }}
          BUILD_ID: ${{ steps.start_build.outputs.build_id }}
          VERSION: ${{ steps.version.outputs.version }}
          VERSION_CODE: ${{ steps.version.outputs.version_code }}
        run: |
          curl -sS -X POST "$SUPABASE_URL/rest/v1/AppConfig?on_conflict=name" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: resolution=merge-duplicates" \
            -d "[{\"name\":\"android_build_url\",\"value\":\"$BUILD_URL\"}]" >/dev/null

          curl -sS -X POST "$SUPABASE_URL/rest/v1/AppConfig?on_conflict=name" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: resolution=merge-duplicates" \
            -d "[{\"name\":\"android_version\",\"value\":\"$VERSION\"}]" >/dev/null

          curl -sS -X POST "$SUPABASE_URL/rest/v1/AppConfig?on_conflict=name" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: resolution=merge-duplicates" \
            -d "[{\"name\":\"android_version_code\",\"value\":\"$VERSION_CODE\"}]" >/dev/null

          curl -sS -X POST "$SUPABASE_URL/rest/v1/AppConfig?on_conflict=name" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: resolution=merge-duplicates" \
            -d "[{\"name\":\"android_build_id\",\"value\":\"$BUILD_ID\"}]" >/dev/null

          echo "✅ Supabase AppConfig updated"
